<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ„Ÿæ¸¬å™¨å„€è¡¨æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 20px; }
        .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; }
        .stat-label { font-size: 14px; opacity: 0.9; }
        .stat-value { font-size: 32px; font-weight: bold; margin-top: 5px; }
        select { padding: 10px; border-radius: 4px; border: 1px solid #ddd; font-size: 14px; }
        .chart-container { position: relative; height: 400px; }
        .update-time { color: #666; font-size: 12px; text-align: right; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ¡ï¸ æ„Ÿæ¸¬å™¨å„€è¡¨æ¿</h1>
        
        <div class="card">
            <label>é¸æ“‡è£ç½®ï¼š</label>
            <select id="deviceSelect" onchange="changeDevice()">
                <option value="pico_001">Pico 001</option>
            </select>
        </div>

        <div class="stats" id="stats">
            <div class="stat-box">
                <div class="stat-label">ç•¶å‰æº«åº¦</div>
                <div class="stat-value" id="currentTemp">--</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">å¹³å‡æº«åº¦</div>
                <div class="stat-value" id="avgTemp">--</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">æœ€é«˜æº«åº¦</div>
                <div class="stat-value" id="maxTemp">--</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">æœ€ä½æº«åº¦</div>
                <div class="stat-value" id="minTemp">--</div>
            </div>
        </div>

        <div class="card">
            <h2>æº«åº¦è¶¨å‹¢åœ–</h2>
            <div class="chart-container">
                <canvas id="tempChart"></canvas>
            </div>
            <div class="update-time" id="updateTime">æœ€å¾Œæ›´æ–°ï¼š--</div>
        </div>

        <div class="card">
            <h2>å¤šè£ç½®æ¯”è¼ƒ</h2>
            <div class="chart-container">
                <canvas id="compareChart"></canvas>
            </div>
            <button onclick="loadComparison()" style="margin-top: 10px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">è¼‰å…¥æ¯”è¼ƒè³‡æ–™</button>
        </div>
    </div>

    <script>
        const UPDATE_INTERVAL = 5000; // 5 ç§’æ›´æ–°ä¸€æ¬¡
        let currentDevice = 'pico_001';
        let chart = null;
        let compareChart = null;

        // åˆå§‹åŒ–åœ–è¡¨
        function initChart() {
            const ctx = document.getElementById('tempChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æº«åº¦ (Â°C)',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false }
                    },
                    plugins: {
                        legend: { display: true }
                    }
                }
            });
        }

        // åˆå§‹åŒ–æ¯”è¼ƒåœ–è¡¨
        function initCompareChart() {
            const ctx = document.getElementById('compareChart').getContext('2d');
            compareChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' }
                    }
                }
            });
        }

        // æ›´æ–°è³‡æ–™
        async function updateData() {
            try {
                // å–å¾—æœ€æ–°è³‡æ–™
                const latestRes = await fetch(`/api/latest?device_id=${currentDevice}`);
                const latestData = await latestRes.json();
                
                if (latestData.data) {
                    document.getElementById('currentTemp').textContent = 
                        latestData.data.value.toFixed(1) + 'Â°C';
                }

                // å–å¾—åœ–è¡¨è³‡æ–™
                const chartRes = await fetch(`/api/chart?device_id=${currentDevice}&hours=6`);
                const chartData = await chartRes.json();
                
                if (chartData.labels && chartData.values) {
                    // æ ¼å¼åŒ–æ™‚é–“æ¨™ç±¤
                    const labels = chartData.labels.map(t => {
                        const date = new Date(t);
                        return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                    });
                    
                    chart.data.labels = labels;
                    chart.data.datasets[0].data = chartData.values;
                    chart.update();

                    // è¨ˆç®—çµ±è¨ˆ
                    const values = chartData.values;
                    if (values.length > 0) {
                        const avg = values.reduce((a, b) => a + b, 0) / values.length;
                        const max = Math.max(...values);
                        const min = Math.min(...values);
                        
                        document.getElementById('avgTemp').textContent = avg.toFixed(1) + 'Â°C';
                        document.getElementById('maxTemp').textContent = max.toFixed(1) + 'Â°C';
                        document.getElementById('minTemp').textContent = min.toFixed(1) + 'Â°C';
                    }
                }

                // æ›´æ–°æ™‚é–“
                document.getElementById('updateTime').textContent = 
                    'æœ€å¾Œæ›´æ–°ï¼š' + new Date().toLocaleTimeString('zh-TW');
                    
            } catch (error) {
                console.error('æ›´æ–°è³‡æ–™å¤±æ•—:', error);
            }
        }

        // è¼‰å…¥è£ç½®åˆ—è¡¨
        async function loadDevices() {
            try {
                const res = await fetch('/api/devices');
                const data = await res.json();
                
                if (data.devices) {
                    const select = document.getElementById('deviceSelect');
                    select.innerHTML = '';
                    data.devices.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device;
                        option.textContent = device;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('è¼‰å…¥è£ç½®åˆ—è¡¨å¤±æ•—:', error);
            }
        }

        // åˆ‡æ›è£ç½®
        function changeDevice() {
            currentDevice = document.getElementById('deviceSelect').value;
            updateData();
        }

        // è¼‰å…¥å¤šè£ç½®æ¯”è¼ƒ
        async function loadComparison() {
            try {
                const res = await fetch('/api/compare?hours=6');
                const data = await res.json();
                
                if (data.data) {
                    const colors = [
                        '#667eea', '#f093fb', '#4facfe', 
                        '#43e97b', '#fa709a', '#feca57'
                    ];
                    
                    const datasets = [];
                    let allLabels = [];
                    let colorIndex = 0;
                    
                    for (const [device, deviceData] of Object.entries(data.data)) {
                        // æ ¼å¼åŒ–æ™‚é–“æ¨™ç±¤
                        const labels = deviceData.labels.map(t => {
                            const date = new Date(t);
                            return date.toLocaleTimeString('zh-TW', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                        });
                        
                        if (labels.length > allLabels.length) {
                            allLabels = labels;
                        }
                        
                        datasets.push({
                            label: device,
                            data: deviceData.values,
                            borderColor: colors[colorIndex % colors.length],
                            backgroundColor: 'transparent',
                            tension: 0.4
                        });
                        
                        colorIndex++;
                    }
                    
                    compareChart.data.labels = allLabels;
                    compareChart.data.datasets = datasets;
                    compareChart.update();
                }
            } catch (error) {
                console.error('è¼‰å…¥æ¯”è¼ƒè³‡æ–™å¤±æ•—:', error);
                alert('è¼‰å…¥æ¯”è¼ƒè³‡æ–™å¤±æ•—ï¼Œè«‹ç¢ºèªæœ‰å¤šå€‹è£ç½®çš„è³‡æ–™');
            }
        }

        // åˆå§‹åŒ–
        initChart();
        initCompareChart();
        loadDevices();
        updateData();
        setInterval(updateData, UPDATE_INTERVAL);
    </script>
</body>
</html>
