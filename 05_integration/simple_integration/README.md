# ç°¡å–®æ•´åˆç¯„ä¾‹

é€™å€‹ç¯„ä¾‹å±•ç¤ºå¦‚ä½•æ•´åˆ Pico MQTT ç™¼å¸ƒå’Œ Pi è¨‚é–±ï¼Œå»ºç«‹åŸºæœ¬çš„è³‡æ–™æµç¨‹ã€‚

## ğŸ“‹ å­¸ç¿’ç›®æ¨™

- ç†è§£ Pico åˆ° Pi çš„å®Œæ•´è³‡æ–™æµç¨‹
- å­¸ç¿’å¦‚ä½•æ•´åˆ MQTT ç™¼å¸ƒè€…å’Œè¨‚é–±è€…
- æŒæ¡åŸºæœ¬çš„é™¤éŒ¯å’Œæ—¥èªŒè¿½è¹¤æŠ€å·§

## ğŸ”§ å‰ç½®éœ€æ±‚

### ç¡¬é«”
- Raspberry Pi Pico Wï¼ˆå·²å®‰è£ MicroPythonï¼‰
- Raspberry Piï¼ˆå·²å®‰è£ Raspberry Pi OSï¼‰
- å…©è€…åœ¨åŒä¸€å€‹ WiFi ç¶²è·¯ä¸­

### è»Ÿé«”
- Pi ä¸Šå·²å®‰è£ä¸¦å•Ÿå‹• Mosquitto MQTT Broker
- Pi ä¸Šå·²å®‰è£ `paho-mqtt` å¥—ä»¶

## ğŸ“ æª”æ¡ˆèªªæ˜

```
simple_integration/
â”œâ”€â”€ README.md              # æœ¬èªªæ˜æ–‡ä»¶
â”œâ”€â”€ pico_publisher.py      # Pico ç«¯ï¼šMQTT ç™¼å¸ƒè€…
â””â”€â”€ pi_subscriber.py       # Pi ç«¯ï¼šMQTT è¨‚é–±è€…
```

## ğŸš€ ä½¿ç”¨æ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šç¢ºèª MQTT Broker é‹ä½œ

åœ¨ Pi ä¸ŠåŸ·è¡Œï¼š

```bash
# æª¢æŸ¥ Mosquitto ç‹€æ…‹
sudo systemctl status mosquitto

# å¦‚æœæœªå•Ÿå‹•ï¼Œè«‹å•Ÿå‹•å®ƒ
sudo systemctl start mosquitto
```

### æ­¥é©Ÿ 2ï¼šè¨­å®š Pico ç™¼å¸ƒè€…

1. é–‹å•Ÿ `pico_publisher.py`
2. ä¿®æ”¹ä»¥ä¸‹é…ç½®åƒæ•¸ï¼š

```python
WIFI_SSID = "your_wifi_ssid"        # ä½ çš„ WiFi åç¨±
WIFI_PASSWORD = "your_wifi_password"  # ä½ çš„ WiFi å¯†ç¢¼
MQTT_BROKER = "192.168.1.100"       # ä½ çš„ Pi IP ä½å€
```

3. å°‡ç¨‹å¼ä¸Šå‚³åˆ° Pico ä¸¦åŸ·è¡Œ

### æ­¥é©Ÿ 3ï¼šå•Ÿå‹• Pi è¨‚é–±è€…

åœ¨ Pi ä¸ŠåŸ·è¡Œï¼š

```bash
cd 05_integration/simple_integration
python3 pi_subscriber.py
```

ä½ æ‡‰è©²æœƒçœ‹åˆ°é¡ä¼¼ä»¥ä¸‹çš„è¼¸å‡ºï¼š

```
============================================================
Pi ç°¡å–®æ•´åˆç¯„ä¾‹ - MQTT è¨‚é–±è€…
============================================================

æ­£åœ¨é€£æ¥åˆ° MQTT Broker: localhost:1883...
âœ“ æˆåŠŸé€£æ¥åˆ° MQTT Broker
âœ“ è¨‚é–±ä¸»é¡Œ: sensors/#

ç­‰å¾…æ¥æ”¶è³‡æ–™...
æŒ‰ Ctrl+C åœæ­¢

[2025-10-11 10:30:15] æ”¶åˆ°è³‡æ–™
  ä¸»é¡Œ: sensors/pico_001/temperature
  è£ç½®: pico_001
  æ„Ÿæ¸¬å™¨: temperature
  æ•¸å€¼: 25.5 celsius
------------------------------------------------------------
```

## ğŸ“Š è³‡æ–™æµç¨‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pico Sensor    â”‚
â”‚  (æº«åº¦æ„Ÿæ¸¬å™¨)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ è®€å–è³‡æ–™
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pico Publisher â”‚
â”‚  (MQTT ç™¼å¸ƒ)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ WiFi
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MQTT Broker    â”‚
â”‚  (Mosquitto)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pi Subscriber  â”‚
â”‚  (æ¥æ”¶ä¸¦é¡¯ç¤º)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” ç¨‹å¼ç¢¼é‡é»èªªæ˜

### Pico ç«¯ (pico_publisher.py)

**WiFi é€£æ¥**
```python
def connect_wifi():
    wlan = network.WLAN(network.STA_IF)
    wlan.active(True)
    wlan.connect(WIFI_SSID, WIFI_PASSWORD)
    # ç­‰å¾…é€£æ¥å®Œæˆ
```

**æ„Ÿæ¸¬å™¨è®€å–**
```python
def read_temperature():
    sensor = machine.ADC(4)  # å…§å»ºæº«åº¦æ„Ÿæ¸¬å™¨
    reading = sensor.read_u16()
    # è½‰æ›ç‚ºæ”æ°æº«åº¦
    temperature = 27 - (voltage - 0.706) / 0.001721
    return temperature
```

**MQTT ç™¼å¸ƒ**
```python
def publish_sensor_data(client):
    data = {
        "device_id": DEVICE_ID,
        "value": temperature,
        "timestamp": time.time()
    }
    payload = json.dumps(data)
    client.publish(topic, payload)
```

### Pi ç«¯ (pi_subscriber.py)

**MQTT è¨‚é–±**
```python
def on_connect(client, userdata, flags, rc):
    client.subscribe("sensors/#")  # è¨‚é–±æ‰€æœ‰æ„Ÿæ¸¬å™¨ä¸»é¡Œ
```

**è¨Šæ¯è™•ç†**
```python
def on_message(client, userdata, msg):
    payload = msg.payload.decode('utf-8')
    data = json.loads(payload)
    # é¡¯ç¤ºæ¥æ”¶åˆ°çš„è³‡æ–™
    print(f"è£ç½®: {data['device_id']}")
    print(f"æ•¸å€¼: {data['value']}")
```

## ğŸ› å¸¸è¦‹å•é¡Œæ’é™¤

### å•é¡Œ 1ï¼šPico ç„¡æ³•é€£æ¥ WiFi

**ç—‡ç‹€ï¼š** é¡¯ç¤º "WiFi é€£æ¥å¤±æ•—ï¼"

**è§£æ±ºæ–¹æ³•ï¼š**
1. ç¢ºèª WiFi SSID å’Œå¯†ç¢¼æ­£ç¢º
2. ç¢ºèª WiFi æ˜¯ 2.4GHzï¼ˆPico W ä¸æ”¯æ´ 5GHzï¼‰
3. æª¢æŸ¥ WiFi è¨Šè™Ÿå¼·åº¦

### å•é¡Œ 2ï¼šPico ç„¡æ³•é€£æ¥ MQTT Broker

**ç—‡ç‹€ï¼š** é¡¯ç¤º "MQTT é€£æ¥å¤±æ•—"

**è§£æ±ºæ–¹æ³•ï¼š**
1. ç¢ºèª Pi çš„ IP ä½å€æ­£ç¢º
2. ç¢ºèª Mosquitto å·²å•Ÿå‹•ï¼š`sudo systemctl status mosquitto`
3. æ¸¬è©¦é€£æ¥ï¼š`mosquitto_sub -h localhost -t "test"`

### å•é¡Œ 3ï¼šPi è¨‚é–±è€…æ²’æœ‰æ”¶åˆ°è³‡æ–™

**ç—‡ç‹€ï¼š** Pi è¨‚é–±è€…å•Ÿå‹•å¾Œæ²’æœ‰é¡¯ç¤ºä»»ä½•è³‡æ–™

**è§£æ±ºæ–¹æ³•ï¼š**
1. ç¢ºèª Pico ç¨‹å¼æ­£åœ¨åŸ·è¡Œ
2. ä½¿ç”¨ `mosquitto_sub` æ¸¬è©¦ï¼š
   ```bash
   mosquitto_sub -h localhost -t "sensors/#" -v
   ```
3. æª¢æŸ¥é˜²ç«ç‰†è¨­å®š

### å•é¡Œ 4ï¼šè³‡æ–™æ ¼å¼éŒ¯èª¤

**ç—‡ç‹€ï¼š** é¡¯ç¤º "JSON è§£æéŒ¯èª¤"

**è§£æ±ºæ–¹æ³•ï¼š**
1. ç¢ºèª Pico ç™¼é€çš„æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼
2. æª¢æŸ¥ç·¨ç¢¼æ˜¯å¦ç‚º UTF-8
3. æŸ¥çœ‹åŸå§‹è³‡æ–™å…§å®¹é€²è¡Œé™¤éŒ¯

## ğŸ“ ç·´ç¿’é¡Œ

### ç·´ç¿’ 1ï¼šä¿®æ”¹ç™¼å¸ƒé–“éš”
ä¿®æ”¹ `pico_publisher.py` ä¸­çš„ `PUBLISH_INTERVAL`ï¼Œè§€å¯Ÿè³‡æ–™ç™¼å¸ƒé »ç‡çš„è®ŠåŒ–ã€‚

### ç·´ç¿’ 2ï¼šåŠ å…¥ LED æŒ‡ç¤º
åœ¨ Pico ç«¯åŠ å…¥ LED é–ƒçˆï¼Œæ¯æ¬¡ç™¼å¸ƒè³‡æ–™æ™‚é–ƒçˆä¸€æ¬¡ã€‚

æç¤ºï¼š
```python
led = machine.Pin("LED", machine.Pin.OUT)
led.toggle()  # åˆ‡æ› LED ç‹€æ…‹
```

### ç·´ç¿’ 3ï¼šè³‡æ–™éæ¿¾
ä¿®æ”¹ Pi è¨‚é–±è€…ï¼Œåªé¡¯ç¤ºæº«åº¦è¶…é 30Â°C çš„è³‡æ–™ã€‚

### ç·´ç¿’ 4ï¼šçµ±è¨ˆè³‡è¨Š
åœ¨ Pi è¨‚é–±è€…ä¸­åŠ å…¥çµ±è¨ˆåŠŸèƒ½ï¼Œé¡¯ç¤ºï¼š
- æ¥æ”¶åˆ°çš„ç¸½è¨Šæ¯æ•¸
- å¹³å‡æº«åº¦
- æœ€é«˜/æœ€ä½æº«åº¦

## ğŸ¯ æª¢æ ¸æ¸…å–®

å®Œæˆä»¥ä¸‹é …ç›®å¾Œï¼Œä½ å°±æŒæ¡äº†ç°¡å–®æ•´åˆçš„åŸºç¤ï¼š

- [ ] æˆåŠŸé€£æ¥ Pico åˆ° WiFi
- [ ] æˆåŠŸé€£æ¥ Pico åˆ° MQTT Broker
- [ ] Pico èƒ½å¤ å®šæœŸç™¼å¸ƒæ„Ÿæ¸¬å™¨è³‡æ–™
- [ ] Pi èƒ½å¤ æ¥æ”¶ä¸¦é¡¯ç¤ºè³‡æ–™
- [ ] ç†è§£å®Œæ•´çš„è³‡æ–™æµç¨‹
- [ ] èƒ½å¤ é€²è¡ŒåŸºæœ¬çš„é™¤éŒ¯

## ğŸ“š å»¶ä¼¸å­¸ç¿’

- å˜—è©¦ç™¼å¸ƒå¤šç¨®æ„Ÿæ¸¬å™¨è³‡æ–™ï¼ˆæº«åº¦ã€æ¿•åº¦ç­‰ï¼‰
- å¯¦ä½œéŒ¯èª¤é‡é€£æ©Ÿåˆ¶
- åŠ å…¥è³‡æ–™é©—è­‰åŠŸèƒ½
- æ¢ç´¢ MQTT QoSï¼ˆæœå‹™å“è³ªï¼‰è¨­å®š

## ğŸ”— ç›¸é—œè³‡æº

- [MQTT å”å®šèªªæ˜](../../03_mqtt_communication/README.md)
- [Pico MQTT å®¢æˆ¶ç«¯](../../03_mqtt_communication/pico_publisher/README.md)
- [Pi MQTT å®¢æˆ¶ç«¯](../../03_mqtt_communication/pi_subscriber/README.md)
